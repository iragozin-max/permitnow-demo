<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PermitNow Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    textarea { width: 100%; height: 100px; margin-top: 10px; }
    pre { background: #fff; padding: 15px; border: 1px solid #ccc; white-space: pre-wrap; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>PermitNow Prototype</h1>
  <p>Ask your zoning/permit question below:</p>
  <textarea id="question" placeholder="Example: Can I build a 10x12 shed (120 sqft) in my backyard at 1800 Falls Rd?"></textarea>
  <br/>
  <button onclick="processQuestion()">Submit</button>
  <h2>Response:</h2>
  <pre id="output"></pre>

  <script>
    let addresses={}, fees={}, forms={}, permits={}, rules={};

    async function loadData(){
      addresses = await fetch('data/addresses.sample.json').then(r=>r.json());
      fees = await fetch('data/fees.village.json').then(r=>r.json());
      forms = await fetch('data/forms.village.json').then(r=>r.json());
      permits = await fetch('data/permits.village.json').then(r=>r.json());
      rules = await fetch('data/rules.village.json').then(r=>r.json());
    }

    // More forgiving address parser
    function parseAddress(text){
      const t = text.replace(/[?!.]/g,' ').trim();

      // 1) Full style: "1800 Falls Rd, Grafton WI 53024"
      const full = t.match(/\b(\d{2,6}\s+[A-Za-z0-9 .'-]+,\s*Grafton\s*WI(?:\s*\d{5})?)\b/i);
      if (full) return full[1].trim();

      // 2) Street-only: "1800 Falls Rd"
      const streetType = "(Ave|Avenue|Blvd|Boulevard|Ct|Court|Dr|Drive|Ln|Lane|Pl|Place|Rd|Road|St|Street|Ter|Terrace|Way)";
      const bare = t.match(new RegExp(`\\b(\\d{2,6}\\s+[A-Za-z0-9.'-]+\\s+${streetType})\\b`, "i"));
      if (bare) {
        const addr = bare[1].trim();
        return `${addr}, Grafton WI 53024`;
      }

      // 3) "Falls Road, Grafton"
      const g = t.match(/\b(\d{2,6}\s+[A-Za-z0-9 .'-]+,\s*Grafton)\b/i);
      if (g) return `${g[1].trim()} WI 53024`;

      return null;
    }

    function normalizeAddress(addr){
      return addr
        ? addr.replace(/\b(rd)\b/i, 'Rd').replace(/\s+/g,' ').trim()
        : addr;
    }

    function findProjectType(text){
      text = text.toLowerCase();
      if (text.includes('shed')) return 'shed';
      if (text.includes('garage')) return 'garage';
      if (text.includes('furnace') || text.includes('ac') || text.includes('hvac')) return 'hvac';
      if (text.includes('plumb') || text.includes('water heater')) return 'plumbing';
      if (text.includes('electrical') || text.includes('wiring') || text.includes('panel')) return 'electrical';
      return null;
    }

    function buildResponse(addr, zoning, project){
      let resp = `Address: ${addr || '(please include address)'}\n`;
      resp += `Zoning: ${zoning || '(unknown)'}\n`;
      resp += `Project(s): ${project || '(not recognized)'}\n`;

      if (project && permits[project]){
        resp += `Permits Required: ${permits[project].join(', ')}\n`;
      } else {
        resp += `Permits Required: (not found)\n`;
      }

      if (project && forms[project]){
        resp += `Forms Needed: ${forms[project].join(', ')}\n`;
      }

      if (project && fees[project]){
        resp += `Fees: ${fees[project]}\n`;
      }

      if (project && rules[project]){
        resp += `Rules: ${rules[project]}\n`;
      }

      return resp;
    }

    async function processQuestion(){
      const q = document.getElementById('question').value;
      const addrRaw = parseAddress(q);
      const addrNorm = normalizeAddress(addrRaw);

      let zoning = null;
      if (addrNorm && addresses[addrNorm]){
        zoning = addresses[addrNorm].zoning;
      }

      const project = findProjectType(q);
      const resp = buildResponse(addrNorm, zoning, project);
      document.getElementById('output').innerText = resp;
    }

    loadData();
    <script>
  // Auto-post our document height to the parent (Squarespace) so the iframe resizes.
  function postHeight() {
    const h = document.documentElement.scrollHeight;
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: 'permitnow-height', value: h }, '*');
    }
  }
  window.addEventListener('load', postHeight);
  window.addEventListener('resize', postHeight);
  new MutationObserver(postHeight).observe(document.body, { subtree: true, childList: true, attributes: true });
</script>

  </script>
</body>
</html>
