<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitNow – Grafton Assistant (Demo)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{--bg:#f7f9fb;--card:#fff;--border:#e5e9f0;--ink:#0f172a;--muted:#475569;--link:#1f4ed8}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .title{font-weight:700;font-size:20px} .sub{color:var(--muted);font-size:14px}
    .log{background:var(--card);border:1px solid var(--border);border-radius:12px;min-height:220px;max-height:420px;overflow:auto;padding:12px;margin-top:12px}
    .msg{display:flex;gap:10px;margin:10px 0}.bubble{padding:10px 12px;border-radius:12px;max-width:80%}
    .me .bubble{background:#eaf2ff}.bot .bubble{background:#f2f7f6}
    .row{display:flex;gap:8px;margin-top:8px}.input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px}
    .btn{border:1px solid var(--border);border-radius:10px;padding:10px 14px;cursor:pointer;background:#fff}
    .btn.primary{background:var(--link);color:#fff;border:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7fafc;border:1px solid var(--border);padding:8px;border-radius:8px;display:inline-block}
    footer{margin:16px 0;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div>
          <div class="title">PermitNow</div>
          <div class="sub">Village of Grafton – Zoning & Permit Assistant (Demo)</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <p style="margin:0 0 6px 0;font-weight:600">Ask a zoning/permit question in plain English. Get required permits, fees, and a printable summary.</p>
      <p style="margin:0 0 6px 0;color:#475569">Examples to try:</p>
      <ul style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0 0;padding:0;list-style:none">
        <li><button class="chip" data-text="I want to remodel my kitchen at 1800 Falls Rd, Grafton WI 53024. 8 new recessed lights, 2 new windows, and a water line to the fridge. What permits do I need and how much will it cost?">Kitchen remodel (lights + windows + water line)</button></li>
        <li><button class="chip" data-text="I want to refinish my basement. It’s 850 sqft. What permits do I need, and what’s it going to cost?">Basement remodel (850 sqft)</button></li>
        <li><button class="chip" data-text="Can I build a shed in my backyard at 1800 Falls Rd?">Shed</button></li>
      </ul>

      <div id="log" class="log" aria-live="polite"></div>

      <div class="row">
        <input id="q" class="input" placeholder="Type your question…" />
        <button id="ask" class="btn primary">Ask</button>
      </div>

      <div class="row" style="align-items:center;flex-wrap:wrap">
        <button id="pdf" class="btn" disabled>Download PDF Summary</button>
        <button id="email" class="btn" disabled>Email me this PDF</button>
        <input id="addr" type="email" class="input" style="min-width:260px;max-width:320px" placeholder="you@example.com" />
      </div>
    </div>

    <footer>Brought to you by PermitNow · Demo only — confirm with the Building Inspector.</footer>
  </div>

  <script>
  // --- Local knowledge base (editable) ---
  const KB = {
    meta: { muni: "Village of Grafton, WI" },
    defaults: {
      building_permit: { name:"Building Permit", fee: { type:"sqft", base:50, per_sqft:0.30 } },
      electrical_permit:{ name:"Electrical Permit", fee:{ type:"tier_by_count", tiers:[{max:6,fee:60},{max:12,fee:90},{max:9999,fee:120}] } },
      plumbing_permit: { name:"Plumbing Permit",  fee:{ type:"per_fixture", per:25, min:60 } },
      hvac_permit:     { name:"HVAC/Mechanical Permit", fee:{ type:"flat", amount:75 } },
      window_permit_hint:{ name:"Building Permit (windows)", fee:{ type:"per_unit", per:40, min:80 } }
    },
    intents: [
      {
        id:"kitchen", synonyms:["kitchen remodel","remodel my kitchen","kitchen renovation"],
        requires:["building_permit"], optional:["electrical_permit","plumbing_permit","hvac_permit"],
        questions:[
          {key:"elec_count", ask:"How many new electrical devices (recessed lights/outlets/circuits)?" },
          {key:"plumbing_fixtures", ask:"How many new/relocated plumbing fixtures (sink, DW, fridge water line)?" },
          {key:"windows", ask:"How many new or enlarged windows?" }
        ],
        rules:[
          "Structural changes or window enlargements require building review.",
          "Electrical additions require an electrical permit.",
          "New water lines/fixtures require a plumbing permit.",
          "HVAC permit is required if ducts/vents are added or modified."
        ],
        fee_logic:[
          {ref:"building_permit", if:"always"},
          {ref:"electrical_permit", if:"elec_count>0", count_key:"elec_count"},
          {ref:"plumbing_permit", if:"plumbing_fixtures>0", count_key:"plumbing_fixtures"},
          {ref:"window_permit_hint", if:"windows>0", count_key:"windows"}
        ],
        inspections:["Electrical rough/final (if applicable)","Plumbing rough/final (if applicable)","Final building inspection"]
      },
      {
        id:"basement", synonyms:["basement remodel","finish basement","refinish basement","basement finishing"],
        requires:["building_permit"], optional:["electrical_permit","plumbing_permit","hvac_permit"],
        questions:[
          {key:"sqft", ask:"What’s the finished square footage?" },
          {key:"bedroom", ask:"Any new bedrooms/sleeping rooms (egress required)?" }
        ],
        rules:[
          "Work must comply with building, electrical, plumbing, and HVAC codes.",
          "Egress requirements apply for sleeping rooms per WI UDC.",
          "Smoke/CO detectors must meet current code."
        ],
        fee_logic:[{ref:"building_permit", if:"always"}],
        inspections:["Framing (if applicable)","Electrical rough/final","Plumbing rough/final","HVAC (if modified)","Final building inspection"]
      },
      {
        id:"shed", synonyms:["shed","storage shed","detached shed"],
        requires:["building_permit"],
        questions:[],
        rules:[
          "Rear/side setbacks typically ≥ 5 ft from lot lines (confirm parcel specifics).",
          "No placement within the front yard setback.",
          "Height and total accessory area limits apply per Chapter 19 (Accessory Structures)."
        ],
        fee_logic:[{ref:"building_permit", if:"always"}],
        inspections:["Final building inspection"]
      }
    ]
  };

  // --- Helpers ---
  const $ = s => document.querySelector(s);
  const log = $('#log'), q = $('#q'), ask = $('#ask'), pdfBtn = $('#pdf'), emailBtn = $('#email'), addr = $('#addr');
  let lastSummary = null;

  function add(text, who='bot'){
    const wrap = document.createElement('div'); wrap.className = 'msg '+who;
    const b = document.createElement('div'); b.className = 'bubble'; b.innerHTML = text;
    wrap.appendChild(b); log.appendChild(wrap); log.scrollTop = log.scrollHeight;
  }

  function parseAddress(text){
    const m = text.match(/\b(\d{2,6}\s+[A-Za-z0-9 .'-]+,\s*Grafton\s*WI[^,]*)/i);
    return m ? m[1].trim() : null;
  }

  function extractNumbers(t){
    const nums = { elec_count:0, plumbing_fixtures:0, windows:0, sqft:0 };
    const n = x => isNaN(parseInt(x,10)) ? 0 : parseInt(x,10);
    const lights = t.match(/(\d+)\s+(recessed|can)\s*lights?/); if (lights) nums.elec_count += n(lights[1]);
    const outlets = t.match(/(\d+)\s*outlets?/); if (outlets) nums.elec_count += n(outlets[1]);
    const circuits = t.match(/(\d+)\s*circuits?/); if (circuits) nums.elec_count += n(circuits[1]);
    const wins = t.match(/(\d+)\s+(?:new|added|enlarged)\s+windows?/); if (wins) nums.windows = n(wins[1]);
    const fix = t.match(/(\d+)\s+(fixtures?|sinks?|toilets?|faucets?)/); if (fix) nums.plumbing_fixtures = n(fix[1]);
    if (t.includes('water line')) nums.plumbing_fixtures = Math.max(nums.plumbing_fixtures,1);
    const sq = t.match(/(\d{2,5})\s*(sq\s*ft|sqft|square\s*feet)/); if (sq) nums.sqft = n(sq[1]);
    return nums;
  }

  function detectIntents(text){
    const t = text.toLowerCase();
    const hits = KB.intents.filter(it => it.synonyms.some(s => t.includes(s)));
    // if no explicit intent found, try heuristics
    if (!hits.length){
      if (t.includes('kitchen')) hits.push(KB.intents.find(i=>i.id==='kitchen'));
      else if (t.includes('basement')) hits.push(KB.intents.find(i=>i.id==='basement'));
      else if (t.includes('shed')) hits.push(KB.intents.find(i=>i.id==='shed'));
    }
    return hits.filter(Boolean);
  }

  function feeTextFromDefault(ref, numbers){
    const d = KB.defaults[ref]; if (!d) return { amount:null, text:`${ref}: see schedule` };
    const f = d.fee || {};
    if (f.type==='flat') return { amount:f.amount, text:`${d.name}: $${f.amount} (est.)` };
    if (f.type==='sqft'){
      const sqft = numbers.sqft||0, base=f.base||0, per=f.per_sqft||0;
      if (!sqft) return { amount:null, text:`${d.name}: base $${base} + $${per}/sqft (need sqft)` };
      const amt = Math.round((base + sqft*per)*100)/100;
      return { amount:amt, text:`${d.name}: $${amt} (base $${base} + $${per}/sqft × ${sqft})` };
    }
    if (f.type==='tier_by_count'){
      const count = numbers.elec_count||0;
      if (!count) return { amount:null, text:`${d.name}: tiered by device count (need count)` };
      let fee=null; (f.tiers||[]).some(t=>{ if(count<=t.max){ fee=t.fee; return true } return false; });
      return { amount:fee, text:`${d.name}: $${fee} (for ${count} devices)` };
    }
    if (f.type==='per_fixture'){
      const c = numbers.plumbing_fixtures||0; const per=f.per||0, min=f.min||0;
      if (!c) return { amount:null, text:`${d.name}: min $${min}, $${per}/fixture (need count)` };
      const total = Math.max(min, c*per); return { amount:total, text:`${d.name}: $${total} (min $${min}, $${per}/fixture × ${c})` };
    }
    if (f.type==='per_unit'){
      const c = numbers.windows||0; const per=f.per||0, min=f.min||0;
      if (!c) return { amount:null, text:`${d.name}: min $${min}, $${per}/unit (need count)` };
      const total = Math.max(min, c*per); return { amount:total, text:`${d.name}: $${total} (min $${min}, $${per}/unit × ${c})` };
    }
    return { amount:null, text:`${d.name}: see schedule` };
  }

  function estimate(intent, numbers){
    const permits = (intent.requires||[]).map(k=>KB.defaults[k]);
    const optional = (intent.optional||[]).map(k=>KB.defaults[k]);
    const feeLines=[], inspections=intent.inspections||[];
    let total=0, complete=true;

    (intent.fee_logic||[]).forEach(part=>{
      let include = part.if==='always';
      if (part.if && part.if.includes('elec_count')) include = (numbers.elec_count||0)>0;
      if (part.if && part.if.includes('plumbing_fixtures')) include = (numbers.plumbing_fixtures||0)>0;
      if (part.if && part.if.includes('windows')) include = (numbers.windows||0)>0;
      if (!include) return;
      const f = feeTextFromDefault(part.ref, numbers);
      feeLines.push(f.text);
      if (f.amount!=null) total += f.amount; else complete=false;
    });

    return {
      project: intent.id,
      rules: intent.rules||[],
      permits,
      optionalPermits: optional,
      inspections,
      feeLines,
      total: complete ? `$${total}` : `~$${total} + items needing details`,
      haveAllNumbers: complete
    };
  }

  function render(summary){
    return `<div class="mono">
      <b>Address:</b> ${summary.address}<br/>
      <b>Zoning:</b> R-3 (simulated)<br/>
      <b>Project(s):</b> ${summary.projects.join(', ')}<br/>
      <b>Permits Required:</b><ul>${summary.permits.map(p=>`<li>${p}</li>`).join('')}</ul>
      ${summary.mayNeed.length ? `<b>May Also Need:</b><ul>${summary.mayNeed.map(p=>`<li>${p}</li>`).join('')}</ul>`:''}
      <b>Rules & Notes:</b><ul>${summary.rules.map(r=>`<li>${r}</li>`).join('')}</ul>
      <b>Estimated Fees:</b><ul>${summary.fees.map(f=>`<li>${f}</li>`).join('')}</ul>
      <b>Estimated Total:</b> ${summary.total}<br/>
      <b>Inspections:</b><ul>${summary.inspections.map(i=>`<li>${i}</li>`).join('')}</ul>
      <b>Citations:</b><ul><li>Village of Grafton Zoning Ordinance – Chapter 19</li><li>Wisconsin UDC</li></ul>
    </div>`;
  }

  function toPDF(summary){
    const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt',format:'letter'});
    const M=48,W=612-2*M; let y=M; const line=(t,b=false)=>{doc.setFont('helvetica',b?'bold':'normal'); doc.splitTextToSize(t,W).forEach(v=>{doc.text(v,M,y);y+=18}); y+=2;};
    line('Village of Grafton – Zoning & Permit Summary',1); line('Prepared via PermitNow (Demo)'); y+=6; doc.setLineWidth(.5); doc.line(M,y,M+W,y); y+=14;
    line(`Address: ${summary.address}`,1); line(`Zoning: R-3 (simulated)`); line(`Projects: ${summary.projects.join(', ')}`); y+=6;
    line('Permits Required',1); summary.permits.forEach(p=>line('• '+p)); y+=6;
    if(summary.mayNeed.length){ line('May Also Need',1); summary.mayNeed.forEach(p=>line('• '+p)); y+=6; }
    line('Rules & Notes',1); summary.rules.forEach(r=>line('• '+r)); y+=6;
    line('Estimated Fees',1); summary.fees.forEach(f=>line('• '+f)); line('Estimated Total: '+summary.total,1); y+=6;
    line('Inspections',1); summary.inspections.forEach(i=>line('• '+i)); y+=6;
    line('Citations',1); line('• Village of Grafton Zoning Ordinance – Chapter 19'); line('• Wisconsin UDC');
    y=760; doc.setLineWidth(.5); doc.line(M,y,M+W,y); y+=16; line('Brought to you by PermitNow',1);
    return doc;
  }

  function respond(text){
    const address = parseAddress(text) || 'unknown (please include address)';
    const nums = extractNumbers(text.toLowerCase());
    const intents = detectIntents(text);
    if (!intents.length){
      add("I didn't recognize the project type. Try phrasing like: 'kitchen remodel with 8 recessed lights, 2 new windows, and a fridge water line.'",'bot');
      return;
    }

    // Combine multiple intents if the sentence mentions them
    const results = intents.map(it => estimate(it, nums));
    const projects = results.map(r=>r.project);
    const permits = [...new Set(results.flatMap(r=>r.permits.map(p=>p.name)))];
    const mayNeed = [...new Set(results.flatMap(r=>r.optionalPermits.map(p=>p.name)))];
    const rules = [...new Set(results.flatMap(r=>r.rules))];
    const inspections = [...new Set(results.flatMap(r=>r.inspections))];
    const fees = results.flatMap(r=>r.feeLines);
    const totalText = results.every(r=>r.haveAllNumbers) ? `$${results.reduce((a,r)=>a+(+r.total.replace('$','')||0),0)}` : 'Depends on details (see items above)';

    const summary = { address, projects, permits, mayNeed, rules, inspections, fees, total: totalText };
    lastSummary = summary;
    add(render(summary),'bot');
    pdfBtn.disabled=false; emailBtn.disabled=false;
  }

  function askNow(){
    const text = q.value.trim(); if(!text) return;
    add(text,'me'); q.value=''; respond(text);
  }

  document.addEventListener('click', e => { if (e.target && e.target.classList.contains('chip')) { q.value=e.target.dataset.text; askNow(); }});
  ask.addEventListener('click', askNow);
  q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); askNow(); }});
  pdfBtn.addEventListener('click', ()=>{ if(!lastSummary) return; toPDF(lastSummary).save('PermitNow-Grafton-Summary.pdf'); });
  emailBtn.addEventListener('click', ()=>{ if(!lastSummary) return; const a=addr.value.trim(); if(!a){alert('Enter an email address first.'); return;} toPDF(lastSummary).save('PermitNow-Grafton-Summary.pdf'); alert('Demo: would email to '+a); });

  add('Hi! Ask a zoning/permit question for Grafton. Example: <em>I want to remodel my kitchen…</em>');
  </script>
</body>
</html>
